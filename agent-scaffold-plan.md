## Plan: Config-driven MVP for OpenCode + Copilot (VS Code + CLI)

You’ll keep **all real content** in `.agents/` and drive each target via **config/manifest mappings**, generating only thin “bridge” files where the tool requires a specific discovery folder. For OpenCode, this means **`opencode.json` is the routing layer** using `{file:...}` indirection into `.agents/...`. For Copilot, it’s “config-driven” via a repo manifest plus tool-native discovery folders (`.github/prompts`, `.github/agents`, `.github/skills`, `.github/instructions`, `.github/copilot-instructions.md`).

### Steps

1. Define canonical inventory + schema in `.agents/manifest.(json|yaml)` for prompts, agents, instructions, skills.
2. Implement OpenCode target as config-first: generate `opencode.json` mapping to `{file:./.agents/...}`.
3. Implement Copilot VS Code target: generate `.github/prompts/*.prompt.md`, `.github/agents/*.agent.md`, `.github/instructions/*.instructions.md`, plus `.github/copilot-instructions.md`.
4. Implement Copilot CLI target: reuse `.github/agents`, `.github/skills`, `.github/instructions`, `.github/copilot-instructions.md` (skip prompt files; IDE-only).
5. Add `doctor` to validate: manifest completeness, file existence, and frontmatter compliance per target.

### Further Considerations

1. Copilot “follow pointer” is not guaranteed—prefer Markdown links + tiny inline summaries in bridges.
2. Copilot code review reads only first 4,000 chars of instruction files—keep wrappers short.
3. Decide whether to also generate root `AGENTS.md` for broader ecosystem compatibility.

## Confirmed conventions (so you can lock templates now)

### GitHub Copilot (VS Code) — Prompt files

- **Location:** `.github/prompts/`
- **Extension:** `*.prompt.md`
- **Frontmatter keys (VS Code docs):** `description`, `name`, `argument-hint`, `agent`, `model`, `tools` (header is optional, but recommended for metadata).
- **Body can reference workspace files** (Markdown links) and supports prompt variables like `${selection}` plus `${input:...}`.

### GitHub Copilot — Instructions

- **Repo-wide instructions file:** `.github/copilot-instructions.md` (plain Markdown, no required frontmatter).
- **Path-scoped instructions:** `.github/instructions/*.instructions.md` with YAML frontmatter containing at least `applyTo: "<glob>"`.

### GitHub Copilot CLI — Agents & Skills

- **Repo agents:** `.github/agents/*.agent.md` (Markdown + YAML frontmatter + body prompt; filename restrictions apply).
- **Repo skills:** `.github/skills/<skill>/SKILL.md` (requires YAML frontmatter: `name`, `description`; `license` optional).
- **Prompt files are IDE-only**, so don’t treat `.github/prompts` as a CLI feature.

## OpenCode: config-driven mapping (from the docs you provided)

To stay **config-driven** for OpenCode:

- Generate **`opencode.json`** at repo root.
- Use **`{file:...}` substitution** in config values to point into `.agents/...`.
- Commands can be defined in config under `command.<name>.template` (required), with optional `description`, `agent`, `model`, `subtask`.
- Agents can be defined in config under `agent.<name>.prompt` (or equivalent), again using `{file:...}` to avoid duplication.
- Rules: OpenCode’s native rule mechanism is `AGENTS.md`; if you want config-driven “include canonical rules,” use `opencode.json` instructions globs pointing to `.agents/rules/**/*.md` (and keep `AGENTS.md` as a thin index if you still want it).

## Pinned `.agents/manifest` schema (v1)

This is the contract that makes `add-prompt/add-agent/add-skill/add-instruction` deterministic and makes `sync` fully idempotent.

### Goals / invariants

- **Single source of truth:** all editable content lives under `.agents/`.
- **No copying canonical content into target folders:** generated files are either:
 	- **config-driven references** (OpenCode: `opencode.json` with `{file:...}`), or
 	- **thin bridge stubs** (Copilot: `.github/*` files) that primarily point to `.agents/...`.
- **Idempotent sync:** running `sync` repeatedly produces identical bytes on disk.
- **Deterministic IDs:** artifact IDs are stable, kebab-case, and used for filenames.
- **Generated file provenance:** every generated file starts with a short “generated by agent-scaffold” banner.

### File location

- Primary: `.agents/manifest.yaml`
- Optional: `.agents/manifest.json` (same schema; YAML preferred for humans)

### Top-level schema

```yaml
schemaVersion: 1

project:
 name: agent-scaffold
 description: Multi-agent scaffold manifest
 defaultTargets:
  - opencode
  - copilot-vscode
  - copilot-cli

paths:
 # Canonical, user-edited sources
 promptsDir: .agents/prompts
 commandsDir: .agents/commands
 agentsDir: .agents/agents
 instructionsDir: .agents/instructions
 skillsDir: .agents/skills

targets:
 opencode:
  kind: opencode
  enabled: true
  # Config-driven routing layer. This file is generated.
  configFile: opencode.json
  # OpenCode also supports AGENTS.md rules; we generate an index file.
  rulesIndexFile: AGENTS.md

 copilot-vscode:
  kind: copilot
  enabled: true
  promptsDir: .github/prompts
  agentsDir: .github/agents
  instructionsDir: .github/instructions
  repoInstructionsFile: .github/copilot-instructions.md
  skillsDir: .github/skills

 copilot-cli:
  kind: copilot
  enabled: true
  # CLI shares most repo locations with VS Code, but prompt files are IDE-only.
  agentsDir: .github/agents
  instructionsDir: .github/instructions
  repoInstructionsFile: .github/copilot-instructions.md
  skillsDir: .github/skills

artifacts:
 # “prompts” are primarily for Copilot prompt files (.prompt.md).
 prompts: []
 # “commands” are primarily for OpenCode slash commands (via opencode.json).
 commands: []
 # “agents” are tool agents (OpenCode agents + Copilot custom agents).
 agents: []
 # “instructions” are repo/path-scoped instruction files.
 instructions: []
 # “skills” are skill bundles (SKILL.md + optional assets).
 skills: []
```

### Artifact types

#### 1) `artifacts.prompts[]` (Copilot VS Code prompt files)

Used to generate `.github/prompts/<id>.prompt.md` for `copilot-vscode`.

Required fields:

- `id` (kebab-case)
- `title`
- `canonicalFile` (path under `.agents/prompts/...`)

Optional fields:

- `description`
- `defaultAgent` (e.g., `ask`, `edit`, `agent`, or a custom agent name)
- `defaultModel`
- `tools` (list)
- `targets` overrides

Per-target override shape (for this artifact type):

- `targets.copilot-vscode.enabled` (bool)
- `targets.copilot-vscode.frontmatter` (object; allowed keys: `name`, `description`, `argument-hint`, `agent`, `model`, `tools`)
- `targets.copilot-vscode.outFile` (defaults to `.github/prompts/<id>.prompt.md`)
- `targets.copilot-vscode.stubMode` (defaults to `link`)

Stub body contract (MVP):

- Must contain an explicit pointer line: `Follow instructions in '.agents/prompts/<id>.md'` (or the configured `canonicalFile`).
- Must include a Markdown link to the canonical file to maximize “file as context” pickup.

Example:

```yaml
artifacts:
 prompts:
  - id: explain-code
   title: Explain selected code
   description: Summarize intent and highlight edge cases.
   canonicalFile: .agents/prompts/explain-code.md
   targets:
    copilot-vscode:
     enabled: true
     frontmatter:
      name: explain-code
      description: Explain the selected code.
      agent: ask
      argument-hint: optional focus area
```

#### 2) `artifacts.commands[]` (OpenCode commands via `opencode.json`)

Config-driven, no `.opencode/command/*.md` required for MVP.

Required fields:

- `id` (kebab-case)
- `description`
- `templateFile` (path under `.agents/commands/...`)

Optional fields:

- `agent` (OpenCode agent name)
- `model`
- `subtask` (bool)
- `targets.opencode.name` (if you want a different command name than `id`)

Example:

```yaml
artifacts:
 commands:
  - id: test
   description: Run and summarize tests
   templateFile: .agents/commands/test.md
   targets:
    opencode:
     enabled: true
     name: test
     model: openai/gpt-4.1
```

`sync` will materialize this into `opencode.json` like:

- `command.<name>.description`
- `command.<name>.template: {file: "./.agents/commands/<id>.md"}`

#### 3) `artifacts.agents[]` (OpenCode + Copilot custom agents)

Common required fields:

- `id` (kebab-case)
- `description`

Canonical sources (one of):

- `promptFile` (recommended): points to `.agents/agents/<id>.md` (the full prompt text)
- `prompt` (inline string; discouraged, but allowed)

OpenCode mapping (config-driven):

- `targets.opencode.enabled`
- `targets.opencode.mode` (`primary|subagent|all`)
- `targets.opencode.model`, `temperature`, `permission`, `hidden`, `steps`

Copilot mapping (bridge file):

- `targets.copilot-vscode.enabled` / `targets.copilot-cli.enabled`
- `targets.copilot*.frontmatter` (allowed keys at minimum: `name`, `description`; plus any keys you choose to support)
- `targets.copilot*.outFile` (defaults `.github/agents/<id>.agent.md`)

Example:

```yaml
artifacts:
 agents:
  - id: reviewer
   description: Reviews PRs for correctness and maintainability.
   promptFile: .agents/agents/reviewer.md
   targets:
    opencode:
     enabled: true
     mode: subagent
     model: openai/gpt-4.1
     steps: 20
    copilot-vscode:
     enabled: true
     frontmatter:
      name: reviewer
      description: Code review specialist.
    copilot-cli:
     enabled: true
     frontmatter:
      name: reviewer
      description: Code review specialist.
```

#### 4) `artifacts.instructions[]` (Copilot instruction files + OpenCode rules index)

Two instruction scopes:

- **Repo-wide**: maps to `.github/copilot-instructions.md`
- **Path-scoped**: maps to `.github/instructions/<id>.instructions.md` with `applyTo`

Required fields:

- `id`
- `scope`: `repo|path`
- `canonicalFile`: `.agents/instructions/<id>.md`

Path-scoped additional required field:

- `applyTo`: glob string

Example:

```yaml
artifacts:
 instructions:
  - id: repo-default
   scope: repo
   canonicalFile: .agents/instructions/repo-default.md
   targets:
    copilot-vscode: { enabled: true }
    copilot-cli: { enabled: true }

  - id: typescript
   scope: path
   applyTo: "**/*.ts,**/*.tsx"
   canonicalFile: .agents/instructions/typescript.md
   targets:
    copilot-vscode:
     enabled: true
     frontmatter:
      applyTo: "**/*.ts,**/*.tsx"
```

OpenCode rules handling (config-driven + index file):

- `opencode.json` should include an `instructions` list with globs pointing at `.agents/instructions/**/*.md` and/or `.agents/rules/**/*.md`.
- Generate `AGENTS.md` as a short index that points humans to `.agents/...`.

#### 5) `artifacts.skills[]` (Skill bundles)

Required fields:

- `id` (lowercase, hyphen-separated)
- `canonicalDir`: `.agents/skills/<id>`
- `skillFile`: `.agents/skills/<id>/SKILL.md`

Optional fields:

- `assets`: list of file globs under the canonicalDir

Targets:

- For Copilot, skills are discovered at `.github/skills/<id>/SKILL.md`.

Important note: because skills are *discovered by reading `SKILL.md`*, the bridge approach should either:

- generate a `SKILL.md` wrapper that contains a minimal inline skill definition + link to canonical, or
- accept that skills are the one case where “no-copy” may reduce reliability (and document it).

Example:

```yaml
artifacts:
 skills:
  - id: agent-workflow-builder
   canonicalDir: .agents/skills/agent-workflow-builder
   skillFile: .agents/skills/agent-workflow-builder/SKILL.md
   targets:
    copilot-vscode: { enabled: true }
    copilot-cli: { enabled: true }
```

### Deterministic `add-*` behavior (derived strictly from manifest)

- `add-prompt <id>` creates:
 	- `.agents/prompts/<id>.md` (canonical)
 	- manifest entry in `artifacts.prompts[]`
- `add-agent <id>` creates:
 	- `.agents/agents/<id>.md`
 	- manifest entry in `artifacts.agents[]`
- `add-instruction <id> --scope repo|path [--apply-to <glob>]` creates:
 	- `.agents/instructions/<id>.md`
 	- manifest entry in `artifacts.instructions[]`
- `add-skill <id>` creates:
 	- `.agents/skills/<id>/SKILL.md`
 	- manifest entry in `artifacts.skills[]`

### Idempotent `sync` behavior

- Always writes generated outputs from scratch using a stable ordering (sorted by artifact `id`).
- Overwrites previously generated files, but never edits canonical `.agents/**` content.
- Removes generated files that no longer exist in the manifest (optional `--prune`).

If you agree with this schema, the next step is to define the exact content templates for each generated file (Copilot prompt/agent/instruction wrappers + `opencode.json` writer), plus a `doctor` rule set that validates frontmatter keys and required fields.
